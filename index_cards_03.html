<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Test Cards</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:700' rel='stylesheet' type='text/css'>
    

    <!-- Table Sorter -->
    <link rel="stylesheet" href="js/themes/blue/style.css" type="text/css" id="" media="print, projection, screen" />
<link href="css/tablas.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="container">
    
    <div class="row" id="intro">
    
    <div class="col-md-7 nopaddingL">
    <p>ahora madrid: transparencia</p>
        <hr/>
    <p class="bigger">En nuestra voluntad de trasparencia os mostramos el Presupuesto de Ahora 
    Madrid y los ingresos que llevamos hasta el momento.
    </p>
    
    <p>Nuestra intención es publicar al detalle de cada gasto pasada la campaña y una vez contrastadas las facturas que estamos recibiendo. Igual con los 
    ingresos, ya que debemos verificar los datos de las donaciones y 
    micro-créditos.</p>
    
        </div>
    
    <div class="col-md-5 text-right nopaddingR">
    <p>&nbsp;</p>
    <hr/>
    <select>
      <option value="volvo">Gastos Campaña Elecciones Municipales 2015</option>
      <option value="saab">Ingresos Campaña Elecciones Municipales 2015</option>
      <option value="mercedes">Gastos Ejercicio 2015</option>
      <option value="audi">Ingresos Ejercicio 2015</option>
    </select>
    
    <hr/>
    
    <p><em>última actualización: 20 de mayo, 2015</em></p>
    </div>
    </div>
    
    
    <div class="row">
    <div class="col-md-12 noPadding">
    <div id="graph_tree"></div>
    </div>
    </div>
    
    <!--
    <div class="row">
    <div class="col-md-12">slider</div>
    </div>
    -->
    
    <div class="row" id="sort_and_filters">
    
     <div class="col-md-5 nopaddingL">
     <!-- <p>filter by:</p>-->
      
     <table width="100%" class="table table-condensed">
      <caption>Categoría de gastos</caption>
      
     <tr>
     <td class="c1 td_label"><label><input type="radio" name="tipo_ui" value=".c1"  class="filter_ui"> confección de sobres y papeletas</label></td>
     
     <td align="right"><span class="totC" id="tot_c1">123456</span></td>
     </tr>
     
     <tr>
     <td class="td_label c2"><label>
       <input type="radio" name="tipo_ui" value=".c2" class="filter_ui"> alquiler locales
      </label>
     </td>
     <td align="right"><span class="totC" id="tot_c2">123456</span></td>
     </tr>
     
     <tr>
     <td class="td_label c3"><label>
     <input type="radio" name="tipo_ui" value=".c3" class="filter_ui"> salarios (personal)
     </label>
     </td>
     <td align="right"><span class="totC" id="tot_c3">123456</span></td>
     </tr>
     
     <tr>
     <td class="td_label c4"><label><input type="radio" name="tipo_ui" value=".c4"  class="filter_ui"> servicios profesionales</label></td>
     <td align="right"><span class="totC" id="tot_c4">123456</span></td>
     </tr>
     
    
          
     </table>
     
     </div>
    
    <div class="col-md-5 nopaddingL">
   
    <table width="100%" class="table table-condensed">
    
    <caption>&nbsp;</caption>
    
     <tr>
     <td class="td_label c5"><label><input type="radio" name="tipo_ui" value=".c5"  class="filter_ui"> material gráfico</label></td>
     <td align="right"><span class="totC" id="tot_c5">123456</span></td>
     </tr>
     
      <tr><td class="td_label c6"><label><input type="radio" name="tipo_ui" value=".c6"  class="filter_ui"> actos</label></td>
      <td align="right"><span class="totC" id="tot_c6">123456</span></td>
      </tr>
      
      <tr><td class="td_label c7"><label><input type="radio" name="tipo_ui" value=".c7"  class="filter_ui"> publicidad</label></td>
      <td align="right"><span class="totC" id="tot_c7">123456</span></td>
      </tr>
      
      <tr><td class="td_label c8"><label><input type="radio" name="tipo_ui" value=".c8"  class="filter_ui"> otros</label></td>
      <td align="right"><span class="totC" id="tot_c8">123456</span></td>
      </tr>
      
       <tr>
       <td class="td_label"><label>
       <input type="radio" name="tipo_ui" value="*" checked class="filter_ui"> <strong>TOTAL</strong>
       </label>
       </td>
       <td align="right"><span class="totC" id="tot_cTot">123456</span></td>
       </tr>
       
       
    </table>
     
    <br>
   
       </div>
    
    <div class="col-md-2">
     <table width="100%" class="table table-condensed">
     <caption>Ordenar por:</caption>
     
     <tr>
     <td><label>
     <input type="radio" name="sort_ui" value="money"  class="sort_ui" id="f_money"> valor
     </label></td>
     </tr>
     
     <tr>
     <td><label>
     <input type="radio" name="sort_ui" value="fecha"  class="sort_ui" id="f_fecha"> fecha
     </label></td>
     </tr>
     
     <tr>
     <td><label>
     <input type="radio" name="sort_ui" value="original-order" checked class="sort_ui" id="f_original"> categoría
     </label></td>
     </tr>
     
     <tr><td><a href="datos_03/gastos.csv"><i class="fa fa-download" style="padding-right: 1em;"></i> <small>descargar .csv</small></a></td></tr>
     
     </table>
     
  
    </div>
        
    </div>
    
    
    <div class="row">
    <!-- filled by jQuery -->
    <div class="col-md-12 noPadding" id="facturas"></div>
    </div>
    
    </div> <!-- /container -->



<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
 <script src="js/jquery.min.js"></script>
 <!-- Include all compiled plugins (below), or include individual files as needed -->
 <script src="js/bootstrap.min.js"></script>
 
 <!--
 <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script> 
 <script src="js/jquery.csvToTable.js"></script>
 -->
 
 <script src="js/jquery.formatCurrency-1.4.0.pack.js"></script>
 
 <!-- highcharts.js -->
 <script src="http://code.highcharts.com/highcharts.js"></script>
 <script type="text/javascript" src="http://code.highcharts.com/modules/data.js"></script>
 <script src="http://code.highcharts.com/modules/treemap.js"></script>
 
 <!-- isotope -->
 <script src="js/isotope.pkgd.js"></script>
  <script src="js/packery-mode.pkgd.min.js"></script>
  
  <!-- CSV parse -->
  <!--<script src="js/jquery.csv-0.71.min.js"></script>-->
   <script src="js/papaparse.min.js"></script>
 
 
 <script>
 
 // init variables
 var t_data = [{
         id: 'c1',
         name: 'confección de sobres y papeletas',
         color: "#aa0000"
     }, {
         id: 'c2',
         name: 'alquiler locales',
         color: "#0000aa"
     }, {
         id: 'c3',
         name: 'salarios',
         color: '#00aa00'
     }, {
         id: 'c4',
         name: 'servicios profesionales',
         color: '#00aaaa'
     }, {
         id: 'c5',
         name: 'material gráfico',
         color: '#aa00aa'
     }, {
         id: 'c6',
         name: 'actos',
         color: '#ffaa00'
     }, {
         id: 'c7',
         name: 'publicidad',
         color: '#00ffaa'
     }, {
         id: 'c8',
         name: 'otros',
         color: '#99ff99'
     }];
     
 // totales
 var totByCat = [];
 var totCat = {c1:0.0, c2:0.0,c3:0.0, c4:0.0, c5:0.0, c6:0.0, c7:0.0, c8:0.0, cTot: 0.0}; 
 //console.log(totByCat);
 //console.log(totCat.c3);
 

 Papa.parse("datos_03/gastos.csv", {
 	download: true,
 	header: true,
 	delimiter: "\t",
 	complete: function(results) {
 		// console.log(results.data);
 		
 		$.each( results.data, function( index, value ) {
  		  var obj = value;
 		  //console.log(obj.fecha);
 		  
 		  var div = document.createElement("div");
 		  $(div).attr("class", obj.cat);
 		  $(div).addClass("card");
 		  $(div).data( "class", obj.cat );
 		  $(div).data( "fecha", obj.fecha );
 		  $(div).data( "concepto", obj.concepto );
 		  $(div).data( "money", obj.importe );
 		  $(div).data( "dni", obj.nif );
 		  $(div).data( "benefit", obj.para );
 		  
 		  $(div).append( "<p class='fecha'>la fecha</p>" );
 		  $(div).append( "<p class='concepto'>el concepto</p>" );
 		  $(div).append( "<p class='benefit'>a favor de</p>" );
 		  $(div).append( "<p class='dni'>DNI</p>" );
 		  $(div).append( "<p class='importe'>0</p>" );
 		  
 		  $("#facturas").append(div);
 		  
 		});
 		
 		
 		// fill data
 		fillData();
 	
 	
 	}
 });
 
 
 function initGrid() {
     
     
     var $grid = $('#facturas').isotope({
       // options
       itemSelector: '.card',
       // layoutMode: 'fitRows',
       layoutMode: 'packery',
       packery: {
         gutter: 8
       },
       
       getSortData: {
          // name: '.name', // text from querySelector
         money: function( itemElem ) { // function
             // var weight = $( itemElem ).find('.importe').text();
              // search for data-money
              var weight = $(itemElem).data( "money" );
              return parseFloat( weight.replace( /[\(\)]/g, '') );
            },
          
          
         date: function ( itemElem ) {
                 //var dateStr = $( itemElem ).find('.fecha').text(),
                 var dateStr = $( itemElem ).data( "fecha" ),
                     dateArray = dateStr.split('/'),
                     year = dateArray[2],
                     month = dateArray[1],
                     day = dateArray[0];
                 return new Date(year, month, day);
             }
             
       },
       
      // sortBy: [ 'date', 'money' ],
       
       sortAscending: {
           date: true,
           money: false,
       }
         
     });
     
     // filter
     $("input[name='tipo_ui']").change(function(){
         // Do something interesting here
         var YO = $(this).val();
         //alert(YO);
         $grid.isotope({ filter: YO });
     });
     
     // sort
     $("input[id='f_money']").change(function(){
       $grid.isotope({ sortBy : 'money' });
     });
     
     $("input[id='f_fecha']").change(function(){
      //$grid.isotope({ sortBy : 'original-order' });
       $grid.isotope({ sortBy : 'date' });
     });
     
     $("input[id='f_original']").change(function(){
       $grid.isotope({ sortBy : 'original-order' });
     });
     
     
     
     
 }
 
 

function fillData(){
$("div.card").each(function() {
	var this_div   = $(this);
	var myFecha = $(this).data("fecha");
	var myConcepto = $(this).data("concepto");
	var myMoney = $(this).data("money");
	var myMoneyF = parseFloat(myMoney);
	var myClass = $(this).data("class");
	var myDNI = $(this).data("dni");
	var myBenefit = $(this).data("benefit");
	
	//var addTo = totCat[myClass];
	totCat[myClass] += myMoneyF;
	totCat.cTot += myMoneyF;
	
	// add to graph variables
	var newObject = {name: myConcepto,
		parent: myClass,
		value: myMoneyF
	};
		
	t_data.push(newObject);
	
	$(this).find("p.fecha").text(myFecha);
	$(this).find("p.concepto").text(myConcepto);
	$(this).find("p.benefit").text(myBenefit);
	$(this).find("p.dni").text(myDNI);
	$(this).find("p.importe").text(myMoney);
	
	// NIF ?
	if(myDNI === '') {
		// code to be executed if condition is true
		$(this).find("p.dni").remove();
	}
	
	//console.log(totCat[myClass]);
});

Highcharts.setOptions({
    chart: {
        style: {
            fontFamily: 'Open Sans'
        }
    }
});

$('#graph_tree').highcharts({


	chart: {
          spacingLeft: 0,
          spacingRight: 0
        },
        
        
	plotOptions: {
	      treemap: {
	      
	      borderColor: "#FFFFFF",
	      borderWidth: 2,
	      
	      dataLabels: {
	          enabled: false,  
	          style: {
	               fontWeight: 'normal',
	               fontSize: '12px',
	               textShadow: 'none',
	          }     
	       },
	       
	               
	     }
	},
	
    series: [{
        type: "treemap",
        layoutAlgorithm: 'squarified',
        alternateStartingDirection: true,
        
        levels: [{
            level: 1,
            //layoutAlgorithm: 'sliceAndDice',
            layoutAlgorithm: 'squarified',
            dataLabels: {
                enabled: false,
                align: 'left',
                verticalAlign: 'top',
                style: {
                    fontSize: '16px',
                    fontWeight: 'normal'
                }
            }
        }],
        
        data: t_data
    }],
    title: {
        text: ' '
    }
});

// write totals
$('#tot_c1').text(totCat.c1);
$('#tot_c2').text(totCat.c2);
$('#tot_c3').text(totCat.c3);
$('#tot_c4').text(totCat.c4);
$('#tot_c5').text(totCat.c5);
$('#tot_c6').text(totCat.c6);
$('#tot_c7').text(totCat.c7);
$('#tot_c8').text(totCat.c8);
$('#tot_cTot').text(totCat.cTot);

$('.totC').formatCurrency({
 	decimalSymbol: ',',
	digitGroupSymbol: '.',
	symbol: '€',
	positiveFormat: '%n <span class="euro">%s</span>',
});

$('p.importe').formatCurrency({
 	decimalSymbol: ',',
	digitGroupSymbol: '.',
	symbol: '€',
	positiveFormat: '%n <span class="euro">%s</span>',
});

 initGrid();
 
}

 
 </script>
 
  </body>
</html>

